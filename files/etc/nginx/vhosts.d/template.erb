server {
    listen 80;
    server_name <%= @vhost %>.<%= @domain %>;
    root /var/www/vhosts/<%= @vhost %>.<%= @domain %>/web;
    index app_<%= @domain %>.php;
    access_log /var/www/vhosts/<%= @vhost %>.<%= @domain %>/app/logs/access.log;
    error_log /var/www/vhosts/<%= @vhost %>.<%= @domain %>/app/logs/error.log;

    location  /favicon.ico {
        return 204;
        break;
    }

    location / {
        index app.php;
        try_files $uri @rewriteindex;
    }

    location @rewriteindex {
        rewrite ^(.*)$ /app.php/$1 last;
    }

    location ~ ^/(app|app_dev)\.php(/|$) {
        fastcgi_pass    unix:/run/shm/<%= @vhost %><%= @domain %>.phpfpm.socket;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}


server {
    listen 443 ssl;

    server_name <%= @vhost %>.<%= @domain %>;
    root /var/www/vhosts/<%= @vhost %>.<%= @domain %>/web;
    index app_<%= @domain %>.php;
    access_log /var/www/vhosts/<%= @vhost %>.<%= @domain %>/app/logs/ssl_access.log;
    error_log /var/www/vhosts/<%= @vhost %>.<%= @domain %>/app/logs/ssl_error.log;

    ssl on;
    ssl_certificate /etc/ssl/private/<%= @vhost %><%= @domain %>.crt;
    ssl_certificate_key /etc/ssl/private/<%= @vhost %><%= @domain %>.key;

    ssl_session_timeout 5m;

    ssl_protocols SSLv3 TLSv1;
    ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
    ssl_prefer_server_ciphers on;

    location  /favicon.ico {
        return 204;
        break;
    }

    location / {
        index app.php;
        try_files $uri @rewriteindex;
    }

    location @rewriteindex {
        rewrite ^(.*)$ /app.php/$1 last;
    }

    location ~ ^/(app|app_dev)\.php(/|$) {
        fastcgi_pass    unix:/run/shm/<%= @vhost %><%= @domain %>.phpfpm.socket;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTPS on;
    }

}